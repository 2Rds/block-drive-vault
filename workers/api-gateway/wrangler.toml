# BlockDrive API Gateway Worker
# Handles rate limiting, CORS, and request forwarding to Supabase Edge Functions

name = "blockdrive-api-gateway"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Environment variables (non-sensitive)
[vars]
SUPABASE_URL = "https://uxwfbialyxqaduiartpu.supabase.co"
FILEBASE_GATEWAY = "https://ipfs.filebase.io"
FILEBASE_BUCKET = "blockdrive-storage"
ALLOWED_ORIGINS = "https://blockdrive.io,https://app.blockdrive.io,http://localhost:5173,http://localhost:8080,http://localhost:8081,http://localhost:8082"
RATE_LIMIT_PER_MINUTE = "100"
RATE_LIMIT_BURST = "20"
# FILEBASE_ACCESS_KEY and FILEBASE_SECRET_KEY set via `wrangler secret put`

# KV Namespace for rate limiting
[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "2a7d0c6095cb49c29900f8ec22e07c9d"
preview_id = "5498fac94ce44412b2f1fc542d7449f2"

# R2 bucket binding (for direct storage access)
[[r2_buckets]]
binding = "R2_STORAGE"
bucket_name = "blockdrive-storage"
preview_bucket_name = "blockdrive-storage-preview"

# Durable Objects (for session management)
[[durable_objects.bindings]]
name = "ENCRYPTION_SESSIONS"
class_name = "EncryptionSession"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["EncryptionSession"]

# Development environment
[env.dev]
name = "blockdrive-api-gateway-dev"
vars = { SUPABASE_URL = "https://uxwfbialyxqaduiartpu.supabase.co", FILEBASE_GATEWAY = "https://ipfs.filebase.io", ALLOWED_ORIGINS = "http://localhost:5173,http://localhost:3000,http://localhost:8080,http://localhost:8081,http://localhost:8082" }

[[env.dev.kv_namespaces]]
binding = "RATE_LIMITS"
id = "5498fac94ce44412b2f1fc542d7449f2"

# Staging environment
[env.staging]
name = "blockdrive-api-gateway-staging"
routes = [
  { pattern = "api-staging.blockdrive.io/*", zone_name = "blockdrive.io" }
]

# Production environment
[env.production]
name = "blockdrive-api-gateway"
routes = [
  { pattern = "api.blockdrive.io/*", zone_name = "blockdrive.io" }
]

# Observability
[observability]
enabled = true
